<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: points/update.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: points/update.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const functions = require('firebase-functions');
const admin = require('firebase-admin');

/**
 * Triggers when a new credit_transaction document is created in the credit_transaction collection.
 * Tabulates all credit_transaction documents in the credit_transaction collection
 * and updates the credit field of the chosen team document.
 */
module.exports = functions.firestore
  .document('events/{eventId}/teams/{teamId}/credit_transactions/{credit_transaction_Id}')
  .onCreate((event, context) => {
    // Get an object representing the document
    // e.g. {'name': 'Marie', 'age': 66}
    // Create user using admin SDK
    const eventId = context.params.eventId; 
    const teamId = context.params.teamId;
    // ref to the parent document
    const teamRef = admin.firestore().collection('events').doc(eventId).collection('teams').doc(teamId);
    // get all credit_modified values and add them together
    return teamRef.collection('credit_transactions').get().then(querySnapshot => {
      // get the total comment count
      let credit = 0;
      // loop over bills to create a plain JS array
      querySnapshot.forEach(doc => {
        credit += doc.data().credit_modified
      });            
      // run update
      return updateCredit(credit, teamRef);
    })
  });

/**
 * Updates the credit field of the chosen team document.
 * @param {number} credit - total credits earned by the team
 * @param {Object} teamRef - collection Reference to the specific team document
 */
const updateCredit = (credit, teamRef) => {
  return teamRef.update({ credit: credit })
    .then( doc => (console.log("credit updated", doc)))
    .catch( err => (console.log('cloudFunction-pointsUpdate failed', err)));
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#completeTransaction">completeTransaction</a></li><li><a href="global.html#createExistingStudent">createExistingStudent</a></li><li><a href="global.html#createExistingVolunteer">createExistingVolunteer</a></li><li><a href="global.html#createStudentEntry">createStudentEntry</a></li><li><a href="global.html#createUserEntry">createUserEntry</a></li><li><a href="global.html#createVolunteerEntry">createVolunteerEntry</a></li><li><a href="global.html#deleteDataFromTransaction">deleteDataFromTransaction</a></li><li><a href="global.html#deleteUserEntry">deleteUserEntry</a></li><li><a href="global.html#updateCredit">updateCredit</a></li><li><a href="global.html#updateExistingAcc">updateExistingAcc</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Feb 04 2019 04:11:58 GMT+0800 (Russia TZ 7 Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
